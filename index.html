<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rowing Safety Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .drag-over {
            border: 2px dashed #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6">
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6 sm:p-8 space-y-6">
        <!-- Header Section -->
        <header class="text-center space-y-2">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">Rowing Safety & Crew Tracker</h1>
            <p class="text-gray-500">For members to check in and out.</p>
        </header>

        <!-- Login and Signup Section -->
        <div id="auth-container" class="space-y-4">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 text-center">Login to Continue</h2>
            
            <input type="email" id="auth-email" placeholder="Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="auth-password" placeholder="Password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <button id="login-btn" class="w-full px-6 py-3 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md">
                Log In
            </button>
            <button id="signup-btn" class="w-full px-6 py-3 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md">
                Sign Up
            </button>
            <div id="auth-status-message" class="text-sm font-medium p-2 rounded-lg text-center hidden"></div>
        </div>

        <!-- Main App Content (Hidden by default) -->
        <div id="app-container" class="hidden space-y-6">
            
            <!-- Admin Navigation -->
            <div id="admin-nav" class="flex justify-center gap-4 hidden">
                <button id="go-to-tracker-btn" class="px-4 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md">
                    Safety Tracker
                </button>
                <button id="go-to-crews-btn" class="px-4 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 shadow-md">
                    Crew Management
                </button>
            </div>

            <!-- Safety Tracker View -->
            <div id="tracker-container">
                <!-- Main Lists Container -->
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Club Members List Section -->
                    <div class="flex-1 space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center justify-between">
                            <span>Club Members</span>
                            <span id="member-count" class="bg-blue-100 text-blue-800 text-sm font-bold px-3 py-1 rounded-full">0 members</span>
                        </h2>
                        <input type="text" id="search-member-name" placeholder="Find your name..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="members-list" class="space-y-3 bg-gray-50 rounded-lg p-4 sm:p-6 shadow-inner h-96 overflow-y-auto">
                            <p id="loading-message" class="text-gray-500 text-center animate-pulse">Loading members list...</p>
                        </div>
                    </div>

                    <!-- Currently On Water List Section -->
                    <div class="flex-1 space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center justify-between">
                            <span>Currently On Water</span>
                            <span id="on-water-count" class="bg-green-100 text-green-800 text-sm font-bold px-3 py-1 rounded-full">0 on water</span>
                        </h2>
                        <div id="on-water-list" class="space-y-3 bg-white rounded-lg p-4 sm:p-6 shadow-inner h-96 overflow-y-auto border border-gray-200">
                            <p id="on-water-message" class="text-gray-500 text-center">No one is on the water.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crew Management View -->
            <div id="crews-container" class="hidden space-y-6">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">Crew Management</h2>
                
                <!-- Add Crew Form -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Create a New Crew</h3>
                    <input type="text" id="add-crew-name-input" placeholder="Crew Name (e.g., Novice 4)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="crew-members-dropzone" class="w-full min-h-[8rem] p-4 border-2 border-dashed border-gray-300 rounded-lg flex flex-wrap gap-2 overflow-y-auto transition-colors duration-200">
                        <p id="dropzone-text" class="text-gray-400 text-center w-full">Drag and drop members and a boat here</p>
                    </div>
                    <button id="save-crew-btn" class="w-full px-6 py-3 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md">
                        Save Crew
                    </button>
                </div>

                <div class="flex flex-col lg:flex-row gap-6 mt-6">
                    <!-- Club Members List Section for Crew Management -->
                    <div class="flex-1 space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800">Available Members</h2>
                        <input type="text" id="crew-search-member-name" placeholder="Find a member..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="crew-members-list" class="space-y-3 bg-gray-50 rounded-lg p-4 sm:p-6 shadow-inner h-96 overflow-y-auto">
                            <p id="crew-loading-message" class="text-gray-500 text-center animate-pulse">Loading members list...</p>
                            <!-- Draggable member items will be dynamically added here -->
                        </div>
                    </div>
                    
                    <!-- Available Boats List Section for Crew Management -->
                    <div class="flex-1 space-y-4">
                        <h2 class="text-xl font-semibold text-gray-800">Available Boats</h2>
                        <input type="text" id="boat-search-input" placeholder="Find a boat..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="boats-list" class="space-y-3 bg-gray-50 rounded-lg p-4 sm:p-6 shadow-inner h-96 overflow-y-auto">
                            <p id="boats-loading-message" class="text-gray-500 text-center animate-pulse">Loading boat list...</p>
                            <!-- Draggable boat items will be dynamically added here -->
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <input type="text" id="add-boat-name-input" placeholder="Add new boat name" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="add-boat-class-input" placeholder="Boat Class (e.g., Four)" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="add-boat-btn" class="w-full sm:w-auto px-6 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md">
                                Add Boat
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Saved Crews List Section -->
                <div class="flex-1 border-t border-gray-200 pt-6 mt-6 space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Saved Crews</h3>
                    <div id="saved-crews-list" class="space-y-4">
                        <p class="text-gray-500 text-center animate-pulse">Loading crews...</p>
                        <!-- Crews will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Admin Actions Section (Visible only to admin user) -->
            <div id="admin-actions-container" class="hidden border-t border-gray-200 pt-6 mt-6 space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">Admin Actions</h3>
                
                <!-- Add Member Form -->
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="text" id="add-member-name" placeholder="Enter new member's name" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="add-member-btn" class="w-full sm:w-auto px-6 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 shadow-md">
                        Add Member
                    </button>
                </div>

                <div id="status-message" class="text-sm font-medium p-2 rounded-lg text-center hidden"></div>

                 <div class="mt-4">
                    <button id="clear-all-btn" class="w-full px-6 py-3 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 shadow-md">
                        Clear All On-Water Rowers
                    </button>
                </div>
            </div>
            
            <div class="mt-8">
                <button id="logout-btn" class="w-full px-4 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 shadow-md">
                    Log Out
                </button>
            </div>
        </div>

        <!-- Hidden Modal for Confirmation -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Action</h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-200">Cancel</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-200">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Notification container -->
        <div id="notification-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-sm px-4 hidden">
             <div id="notification-message" class="w-full p-4 rounded-lg bg-blue-600 text-white font-semibold text-center shadow-lg transition-transform transform-gpu duration-500">
                A crew has been posted!
             </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc, getDocs, writeBatch, query, where, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        
        const firebaseConfig = {
          apiKey: "AIzaSyC-OCA-2qBp5DhUIS4GH9FENnGlRrhZ2gk",
          authDomain: "safetytracker-d74d1.firebaseapp.com",
          projectId: "safetytracker-d74d1",
          storageBucket: "safetytracker-d74d1.firebasestorage.app",
          messagingSenderId: "421605254971",
          appId: "1:421605254971:web:2256aa354a3202747b791e",
          measurementId: "G-J4W4K8NSG5"
        };
        const __firebase_config = JSON.stringify(firebaseConfig);
        const __app_id = firebaseConfig.projectId;
        const __initial_auth_token = null;

        let app;
        let db;
        let auth;
        let appId;
        let userId = null;
        let memberList = [];
        let onWaterMap = new Map();
        let crews = [];
        let boats = [];
        let currentView = 'tracker'; // New state variable
        
        // State for managing new crew creation
        let newCrew = {
            members: [],
            boat: null
        };

        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            appId = __app_id;
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
        
        // UI elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const authStatusMessageEl = document.getElementById('auth-status-message');
        const logoutBtn = document.getElementById('logout-btn');

        const adminNav = document.getElementById('admin-nav');
        const goToTrackerBtn = document.getElementById('go-to-tracker-btn');
        const goToCrewsBtn = document.getElementById('go-to-crews-btn');

        const trackerContainer = document.getElementById('tracker-container');
        const crewsContainer = document.getElementById('crews-container');
        const searchInput = document.getElementById('search-member-name');
        const membersListEl = document.getElementById('members-list');
        const onWaterListEl = document.getElementById('on-water-list');
        const memberCountEl = document.getElementById('member-count');
        const onWaterCountEl = document.getElementById('on-water-count');
        const loadingMessageEl = document.getElementById('loading-message');
        const onWaterMessageEl = document.getElementById('on-water-message');
        const clearAllBtn = document.getElementById('clear-all-btn');
        
        const adminActionsContainer = document.getElementById('admin-actions-container');
        const addMemberNameInput = document.getElementById('add-member-name');
        const addMemberBtn = document.getElementById('add-member-btn');
        const statusMessageEl = document.getElementById('status-message');

        const modal = document.getElementById('modal');
        const modalMessageEl = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const addCrewNameInput = document.getElementById('add-crew-name-input');
        const saveCrewBtn = document.getElementById('save-crew-btn');
        const savedCrewsListEl = document.getElementById('saved-crews-list');
        const crewMembersDropzone = document.getElementById('crew-members-dropzone');
        const dropzoneText = document.getElementById('dropzone-text');
        const crewMembersListEl = document.getElementById('crew-members-list');
        const crewSearchInput = document.getElementById('crew-search-member-name');
        const boatsListEl = document.getElementById('boats-list');
        const boatSearchInput = document.getElementById('boat-search-input');
        const boatsLoadingMessageEl = document.getElementById('boats-loading-message');
        const addBoatNameInput = document.getElementById('add-boat-name-input');
        const addBoatClassInput = document.getElementById('add-boat-class-input');
        const addBoatBtn = document.getElementById('add-boat-btn');
        const notificationContainer = document.getElementById('notification-container');
        const notificationMessage = document.getElementById('notification-message');
        
        // Show/Hide Modal
        function showModal(message, onConfirm) {
            modalMessageEl.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            modalConfirmBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                onConfirm();
            };
            
            modalCancelBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
        }
        
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationContainer.classList.remove('hidden');
            setTimeout(() => {
                notificationContainer.classList.add('hidden');
            }, 5000);
        }

        // --- Auth Functions ---
        async function setStatusMessage(message, type = 'error') {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (type === 'error') {
                statusMessageEl.classList.add('bg-red-100', 'text-red-800');
            } else {
                statusMessageEl.classList.add('bg-green-100', 'text-green-800');
            }
            setTimeout(() => {
                statusMessageEl.classList.add('hidden');
            }, 5000);
        }

        loginBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authStatusMessageEl.textContent = `Login failed: ${error.message}`;
            }
        });

        signupBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                authStatusMessageEl.textContent = 'Signup successful! You can now log in.';
            } catch (error) {
                authStatusMessageEl.textContent = `Signup failed: ${error.message}`;
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });
        
        let isAdmin = false;
        const initialAdminEmail = 'rbvandijk@gmail.com'; // CHANGE THIS TO YOUR ADMIN'S EMAIL

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Check if user is the admin
                isAdmin = (user.email === initialAdminEmail);
                if (isAdmin) {
                    adminActionsContainer.classList.remove('hidden');
                    adminNav.classList.remove('hidden');
                    listenForCrews();
                    listenForBoats();
                } else {
                    adminActionsContainer.classList.add('hidden');
                    adminNav.classList.add('hidden');
                }

                await initializeMasterList();
                listenForMembers();
                listenForOnWaterLog();
            } else {
                userId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
        
        // --- Navigation ---
        goToTrackerBtn.addEventListener('click', () => {
            trackerContainer.classList.remove('hidden');
            crewsContainer.classList.add('hidden');
            currentView = 'tracker';
        });

        goToCrewsBtn.addEventListener('click', () => {
            trackerContainer.classList.add('hidden');
            crewsContainer.classList.remove('hidden');
            currentView = 'crews';
            renderCrewMembersList();
            renderBoatsList();
        });

        // --- Firestore Initialization and Listeners ---

        async function initializeMasterList() {
            const membersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            const membersSnap = await getDocs(membersColRef);

            if (membersSnap.empty) {
                const sampleNames = ["Alex Smith", "Ben Jones", "Chloe Davis", "Daniel Evans", "Emily Foster", "Frank Green", "Grace Hall", "Henry White", "Isla King", "Jacob Lee"];
                const batch = writeBatch(db);
                sampleNames.forEach(name => {
                    const memberId = name.replace(/\s/g, '').toLowerCase();
                    const docRef = doc(membersColRef, memberId);
                    batch.set(docRef, { name: name });
                });
                await batch.commit();
            }
        }
        
        function listenForCrews() {
            const crewsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'crews');
            onSnapshot(crewsColRef, (snapshot) => {
                crews = snapshot.docs.map(d => ({ id: d.id, name: d.data().name, members: d.data().members, boat: d.data().boat }));
                renderCrewsList();
            }, (error) => {
                console.error("Error fetching crews:", error);
            });
        }
        
        function listenForBoats() {
            const boatsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'boats');
            onSnapshot(boatsColRef, (snapshot) => {
                boats = snapshot.docs.map(d => ({ id: d.id, name: d.data().name, class: d.data().class }));
                renderBoatsList();
            }, (error) => {
                console.error("Error fetching boats:", error);
            });
        }

        function listenForMembers() {
            const membersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            onSnapshot(membersColRef, (snapshot) => {
                memberList = snapshot.docs.map(d => ({ id: d.id, name: d.data().name }));
                memberCountEl.textContent = `${memberList.length} members`;
                renderMembersList();
                renderCrewMembersList();
            }, (error) => {
                console.error("Error fetching members:", error);
            });
        }
        
        function listenForOnWaterLog() {
            const onWaterColRef = collection(db, 'artifacts', appId, 'public', 'data', 'on_water_log');
            onSnapshot(onWaterColRef, (snapshot) => {
                onWaterMap.clear();
                snapshot.forEach(doc => {
                    onWaterMap.set(doc.id, doc.data());
                });
                onWaterCountEl.textContent = `${onWaterMap.size} on water`;
                renderMembersList();
                renderOnWaterList();
            }, (error) => {
                console.error("Error fetching on water log:", error);
            });
        }
        
        // --- UI Rendering Functions ---
        
        function renderMembersList(listToRender = memberList) {
            membersListEl.innerHTML = '';
            loadingMessageEl.classList.add('hidden');
            
            if (listToRender.length === 0) {
                membersListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No members match your search.</p>';
            }

            listToRender.forEach(member => {
                const isOnWater = onWaterMap.has(member.id);
                const memberItem = document.createElement('div');
                memberItem.className = `flex items-center justify-between p-4 rounded-lg shadow-sm border border-gray-200 transition-transform transform hover:scale-105 ${isOnWater ? 'bg-green-100' : 'bg-white'}`;
                
                let checkInOutButton = `
                    <button class="check-btn px-4 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out ${isOnWater ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}"
                            data-member-id="${member.id}"
                            data-is-on-water="${isOnWater}">
                        ${isOnWater ? 'Check Out' : 'Check In'}
                    </button>
                `;
                
                memberItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-900 text-lg">${member.name}</p>
                        ${onWaterMap.get(member.id)?.boatName ? `<p class="text-sm text-gray-600">Boat: ${onWaterMap.get(member.id).boatName}</p>` : ''}
                        ${onWaterMap.get(member.id)?.seatNumber ? `<p class="text-sm text-gray-600">Seat: ${onWaterMap.get(member.id).seatNumber}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        ${checkInOutButton}
                    </div>
                `;
                membersListEl.appendChild(memberItem);
            });

            document.querySelectorAll('.check-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const memberId = event.currentTarget.getAttribute('data-member-id');
                    const isOnWater = event.currentTarget.getAttribute('data-is-on-water') === 'true';
                    const memberName = memberList.find(m => m.id === memberId).name;

                    if (isOnWater) {
                        showModal(`Are you sure you want to check out ${memberName}?`, () => {
                            checkOutRower(memberId);
                        });
                    } else {
                        checkInRower(memberId, memberName);
                    }
                });
            });
        }
        
        function renderOnWaterList() {
            onWaterListEl.innerHTML = '';
            onWaterMessageEl.classList.add('hidden');
            
            if (onWaterMap.size === 0) {
                onWaterMessageEl.classList.remove('hidden');
                return;
            }
            
            const onWaterRowers = Array.from(onWaterMap.values());
            onWaterRowers.forEach(rower => {
                const rowerItem = document.createElement('div');
                const lastUpdated = rower.timestamp ? new Date(rower.timestamp.toDate()).toLocaleTimeString() : 'N/A';
                
                rowerItem.className = 'flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200';
                
                rowerItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-900 text-lg">${rower.name}</p>
                        ${rower.boatName ? `<p class="text-xs text-gray-500">Boat: ${rower.boatName}</p>` : ''}
                        ${rower.seatNumber ? `<p class="text-xs text-gray-500">Seat: ${rower.seatNumber}</p>` : ''}
                        <p class="text-xs text-gray-500">Checked in at: ${lastUpdated}</p>
                    </div>
                `;
                onWaterListEl.appendChild(rowerItem);
            });
        }
        
        function renderCrewMembersList(listToRender = memberList) {
            crewMembersListEl.innerHTML = '';
            
            const crewMemberIds = newCrew.members.map(m => m.id);
            const availableMembers = listToRender.filter(m => !crewMemberIds.includes(m.id));

            if (availableMembers.length === 0) {
                crewMembersListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No members available.</p>';
            }

            availableMembers.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-grab';
                memberItem.textContent = member.name;
                memberItem.setAttribute('draggable', true);
                memberItem.setAttribute('data-member-id', member.id);
                memberItem.setAttribute('data-member-name', member.name);
                crewMembersListEl.appendChild(memberItem);
            });
            setupDragAndDrop();
        }

        function renderBoatsList(listToRender = boats) {
            boatsListEl.innerHTML = '';
            boatsLoadingMessageEl.classList.add('hidden');
            
            if (listToRender.length === 0) {
                boatsListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No boats added yet.</p>';
            }

            listToRender.forEach(boat => {
                const boatItem = document.createElement('div');
                boatItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200 cursor-grab';
                boatItem.setAttribute('draggable', true);
                boatItem.setAttribute('data-boat-id', boat.id);
                boatItem.setAttribute('data-boat-name', boat.name);
                boatItem.setAttribute('data-boat-class', boat.class);
                
                boatItem.innerHTML = `
                    <p class="flex-grow">${boat.name} (${boat.class})</p>
                    <button class="delete-boat-btn text-red-500 hover:text-red-700 transition-colors" data-boat-id="${boat.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M16.5 4.475C16.5 3.197 15.303 2 14.025 2H9.975C8.697 2 7.5 3.197 7.5 4.475v.225a.75.75 0 00.75.75h.75a.75.75 0 00.75-.75v-.225a.75.75 0 01.75-.75h2.05a.75.75 0 01.75.75v.225a.75.75 0 00.75.75h.75a.75.75 0 00.75-.75v-.225zM12 5.25a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5zM6.75 8a.75.75 0 00-.75.75v8.5c0 1.278 1.197 2.375 2.375 2.375h5.5c1.178 0 2.375-1.097 2.375-2.375v-8.5a.75.75 0 00-1.5 0v8.5a.75.75 0 01-.75.75h-5.5a.75.75 0 01-.75-.75v-8.5a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                boatsListEl.appendChild(boatItem);
            });
            
            // Set up event listeners for the new delete buttons
            document.querySelectorAll('.delete-boat-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const boatId = event.currentTarget.getAttribute('data-boat-id');
                    const boatName = boats.find(b => b.id === boatId).name;
                    showModal(`Are you sure you want to delete the boat "${boatName}"? This cannot be undone.`, () => {
                        deleteBoat(boatId);
                    });
                    event.stopPropagation();
                });
            });

            setupDragAndDrop();
        }

        function renderCrewsList() {
            savedCrewsListEl.innerHTML = '';
            if (crews.length === 0) {
                savedCrewsListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No crews have been saved yet.</p>';
                return;
            }
            crews.forEach(crew => {
                const crewItem = document.createElement('div');
                crewItem.className = 'p-4 bg-gray-100 rounded-lg shadow-sm border border-gray-200 space-y-2 relative';
                
                const memberListHtml = crew.members.map((m, index) => {
                    let seatNumber = index + 1;
                    const boatClassLower = crew.boat?.class.toLowerCase();
                    const isCoxedBoat = boatClassLower?.includes('coxed') || boatClassLower?.includes('+');
                    const isFourBoat = boatClassLower?.includes('four') || boatClassLower?.startsWith('4');
                    const isEightBoat = boatClassLower?.includes('eight') || boatClassLower?.startsWith('8');

                    if (isCoxedBoat && ((isFourBoat && crew.members.length === 5) || (isEightBoat && crew.members.length === 9)) && index === (crew.members.length - 1)) {
                       seatNumber = 'Cox';
                    }
                    return `<span class="bg-gray-200 px-2 py-1 rounded-full text-sm font-medium">${seatNumber}</span> ${m.name}`;
                }).join(', ');
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'absolute top-2 right-2 px-2 py-1 rounded-lg text-white bg-red-500 hover:bg-red-600 transition-colors';
                deleteBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                        <path fill-rule="evenodd" d="M16.5 4.475C16.5 3.197 15.303 2 14.025 2H9.975C8.697 2 7.5 3.197 7.5 4.475v.225a.75.75 0 00.75.75h.75a.75.75 0 00.75-.75v-.225a.75.75 0 01.75-.75h2.05a.75.75 0 01.75.75v.225a.75.75 0 00.75.75h.75a.75.75 0 00.75-.75v-.225zM12 5.25a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5zM6.75 8a.75.75 0 00-.75.75v8.5c0 1.278 1.197 2.375 2.375 2.375h5.5c1.178 0 2.375-1.097 2.375-2.375v-8.5a.75.75 0 00-1.5 0v8.5a.75.75 0 01-.75.75h-5.5a.75.75 0 01-.75-.75v-8.5a.75.75 0 00-.75-.75z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteBtn.onclick = () => {
                    showModal(`Are you sure you want to delete the crew "${crew.name}"? This action cannot be undone.`, () => {
                        deleteCrew(crew.id);
                    });
                };
                
                crewItem.innerHTML = `
                    <h4 class="font-bold text-gray-900">${crew.name}</h4>
                    <p class="text-sm text-gray-600">Boat: ${crew.boat ? `${crew.boat.name} (${crew.boat.class})` : 'No Boat'}</p>
                    <p class="text-sm text-gray-600">Members: ${memberListHtml}</p>
                    <div class="flex gap-2">
                        <button class="post-crew-btn px-4 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-blue-500 hover:bg-blue-600" data-crew-id="${crew.id}">Post Crew</button>
                        <button class="clear-crew-btn px-4 py-2 rounded-lg text-white font-semibold transition duration-300 ease-in-out bg-red-500 hover:bg-red-600" data-crew-id="${crew.id}">Clear Crew</button>
                    </div>
                `;
                crewItem.appendChild(deleteBtn);
                savedCrewsListEl.appendChild(crewItem);
            });
            setupCrewButtons();
        }
        
        function setupCrewButtons() {
            document.querySelectorAll('.post-crew-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const crewId = event.currentTarget.getAttribute('data-crew-id');
                    const crew = crews.find(c => c.id === crewId);
                    if (crew) {
                        showModal(`Are you sure you want to post the crew "${crew.name}"?`, () => {
                            postCrew(crew);
                        });
                    }
                });
            });

            document.querySelectorAll('.clear-crew-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const crewId = event.currentTarget.getAttribute('data-crew-id');
                    const crew = crews.find(c => c.id === crewId);
                    if (crew) {
                        showModal(`Are you sure you want to clear the crew "${crew.name}"?`, () => {
                            clearCrew(crew);
                        });
                    }
                });
            });
        }
        
        // --- Check-in/Check-out Functions ---

        async function checkInRower(memberId, memberName) {
            const onWaterDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'on_water_log', memberId);
            try {
                await setDoc(onWaterDocRef, { name: memberName, timestamp: new Date() });
            } catch (e) {
                console.error("Error checking in rower:", e);
            }
        }

        async function checkOutRower(memberId) {
            const onWaterDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'on_water_log', memberId);
            try {
                await deleteDoc(onWaterDocRef);
            } catch (e) {
                console.error("Error checking out rower:", e);
            }
        }

        // --- Crew Management Functions ---
        
        // Drag and Drop Logic
        let draggedItem = null;

        function setupDragAndDrop() {
            const items = document.querySelectorAll('#crew-members-list div, #boats-list div');
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = e.target;
                    e.dataTransfer.setData('text/plain', 'drag'); // Required for Firefox
                    e.target.style.opacity = '0.5';
                });
                item.addEventListener('dragend', (e) => {
                    e.target.style.opacity = '1';
                });
            });

            crewMembersDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                crewMembersDropzone.classList.add('drag-over');
            });

            crewMembersDropzone.addEventListener('dragleave', () => {
                crewMembersDropzone.classList.remove('drag-over');
            });

            crewMembersDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                crewMembersDropzone.classList.remove('drag-over');
                
                if (draggedItem) {
                    const isMember = draggedItem.hasAttribute('data-member-id');
                    const isBoat = draggedItem.hasAttribute('data-boat-id');
                    
                    if (isMember) {
                        const boatClassLower = newCrew.boat?.class.toLowerCase();
                        const isFourBoat = boatClassLower?.includes('four') || boatClassLower?.startsWith('4');
                        const isEightBoat = boatClassLower?.includes('eight') || boatClassLower?.startsWith('8');

                        if (isFourBoat && newCrew.members.length >= 5) {
                            setStatusMessage("A four can only have up to 4 rowers and a coxswain.");
                            return;
                        }
                        if (isEightBoat && newCrew.members.length >= 9) {
                            setStatusMessage("An eight can only have up to 8 rowers and a coxswain.");
                            return;
                        }

                        const memberId = draggedItem.getAttribute('data-member-id');
                        const memberName = draggedItem.getAttribute('data-member-name');
                        if (!newCrew.members.some(m => m.id === memberId)) {
                             newCrew.members.push({ id: memberId, name: memberName });
                             updateDropzoneDisplay();
                             renderCrewMembersList(); // Re-render available members
                        }
                    } else if (isBoat) {
                        newCrew.boat = { 
                            id: draggedItem.getAttribute('data-boat-id'),
                            name: draggedItem.getAttribute('data-boat-name'),
                            class: draggedItem.getAttribute('data-boat-class')
                        };
                        updateDropzoneDisplay();
                    }
                }
            });
        }
        
        function updateDropzoneDisplay() {
            crewMembersDropzone.innerHTML = '';
            if (newCrew.members.length === 0 && !newCrew.boat) {
                 crewMembersDropzone.innerHTML = '<p id="dropzone-text" class="text-gray-400 text-center w-full">Drag and drop members and a boat here</p>';
            }
            
            if (newCrew.boat) {
                 const boatEl = document.createElement('div');
                 boatEl.className = 'p-2 bg-blue-100 rounded-lg font-semibold';
                 boatEl.innerHTML = `Boat: ${newCrew.boat.name} (${newCrew.boat.class})`;
                 crewMembersDropzone.appendChild(boatEl);
            }

            newCrew.members.forEach((member, index) => {
                const memberEl = document.createElement('div');
                memberEl.className = 'relative p-2 bg-white rounded-lg shadow-sm border border-gray-200';
                
                let seatNumber = index + 1;
                const boatClassLower = newCrew.boat?.class.toLowerCase();
                const isCoxedBoat = boatClassLower?.includes('coxed') || boatClassLower?.includes('+');
                const isFourBoat = boatClassLower?.includes('four') || boatClassLower?.startsWith('4');
                const isEightBoat = boatClassLower?.includes('eight') || boatClassLower?.startsWith('8');

                if (isCoxedBoat && ((isFourBoat && newCrew.members.length === 5) || (isEightBoat && newCrew.members.length === 9)) && index === (newCrew.members.length - 1)) {
                    seatNumber = 'Cox';
                }
                
                memberEl.innerHTML = `<span class="font-bold text-gray-700">${seatNumber}.</span> ${member.name}`;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'absolute top-0 right-0 p-1 text-red-500 hover:text-red-700 text-xs';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => {
                    newCrew.members = newCrew.members.filter(m => m.id !== member.id);
                    updateDropzoneDisplay();
                    renderCrewMembersList(); // Re-render available members
                };
                memberEl.appendChild(deleteBtn);
                crewMembersDropzone.appendChild(memberEl);
            });
        }

        saveCrewBtn.addEventListener('click', async () => {
            const crewName = addCrewNameInput.value.trim();
            if (!crewName) {
                setStatusMessage("Crew name cannot be empty.");
                return;
            }
            if (newCrew.members.length === 0) {
                 setStatusMessage("Please add members to the crew.");
                 return;
            }
            if (!newCrew.boat) {
                 setStatusMessage("Please add a boat to the crew.");
                 return;
            }

            const boatClassLower = newCrew.boat?.class.toLowerCase();
            const isFourBoat = boatClassLower?.includes('four') || boatClassLower?.startsWith('4');
            const isEightBoat = boatClassLower?.includes('eight') || boatClassLower?.startsWith('8');
            
            if (isFourBoat && newCrew.members.length > 5) {
                setStatusMessage("A four can only have up to 4 rowers and a coxswain.");
                return;
            }
            if (isEightBoat && newCrew.members.length > 9) {
                setStatusMessage("An eight can only have up to 8 rowers and a coxswain.");
                return;
            }

            const crewsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'crews');
            try {
                await addDoc(crewsColRef, {
                    name: crewName,
                    members: newCrew.members,
                    boat: newCrew.boat
                });
                addCrewNameInput.value = '';
                newCrew.members = [];
                newCrew.boat = null;
                updateDropzoneDisplay();
                setStatusMessage('Crew saved successfully!', 'success');
            } catch (e) {
                setStatusMessage(`Error saving crew: ${e.message}`);
            }
        });

        async function deleteCrew(crewId) {
            const crewDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'crews', crewId);
            try {
                await deleteDoc(crewDocRef);
                setStatusMessage('Crew deleted successfully!', 'success');
            } catch (e) {
                setStatusMessage(`Error deleting crew: ${e.message}`);
            }
        }

        async function deleteBoat(boatId) {
            const boatDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'boats', boatId);
            try {
                await deleteDoc(boatDocRef);
                setStatusMessage('Boat deleted successfully!', 'success');
            } catch (e) {
                setStatusMessage(`Error deleting boat: ${e.message}`);
            }
        }

        addBoatBtn.addEventListener('click', async () => {
            const name = addBoatNameInput.value.trim();
            const boatClass = addBoatClassInput.value.trim();
            if (!name || !boatClass) {
                setStatusMessage("Boat name and class cannot be empty.");
                return;
            }

            const boatsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'boats');
            const boatId = name.replace(/\s/g, '').toLowerCase();

            try {
                await setDoc(doc(boatsColRef, boatId), { name: name, class: boatClass });
                addBoatNameInput.value = '';
                addBoatClassInput.value = '';
                setStatusMessage('Boat added successfully!', 'success');
            } catch (e) {
                setStatusMessage(`Error adding boat: ${e.message}`);
            }
        });
        
        async function postCrew(crew) {
            const batch = writeBatch(db);
            const onWaterColRef = collection(db, 'artifacts', appId, 'public', 'data', 'on_water_log');

            crew.members.forEach((member, index) => {
                const docRef = doc(onWaterColRef, member.id);
                let seatNumber = index + 1;
                const boatClassLower = crew.boat?.class.toLowerCase();
                const isCoxedBoat = boatClassLower?.includes('coxed') || boatClassLower?.includes('+');
                const isFourBoat = boatClassLower?.includes('four') || boatClassLower?.startsWith('4');
                const isEightBoat = boatClassLower?.includes('eight') || boatClassLower?.startsWith('8');

                if (isCoxedBoat && ((isFourBoat && crew.members.length === 5) || (isEightBoat && crew.members.length === 9)) && index === (crew.members.length - 1)) {
                    seatNumber = 'Cox';
                }
                batch.set(docRef, { 
                    name: member.name, 
                    boatName: crew.boat?.name, 
                    seatNumber: seatNumber,
                    timestamp: new Date()
                });
            });

            try {
                await batch.commit();
                showNotification(`Crew "${crew.name}" has been posted!`);
            } catch (e) {
                console.error("Error posting crew:", e);
            }
        }

        async function clearCrew(crew) {
            const batch = writeBatch(db);
            const onWaterColRef = collection(db, 'artifacts', appId, 'public', 'data', 'on_water_log');

            crew.members.forEach(member => {
                const docRef = doc(onWaterColRef, member.id);
                batch.delete(doc.ref);
            });

            try {
                await batch.commit();
                showNotification(`Crew "${crew.name}" has been cleared!`);
            } catch (e) {
                console.error("Error clearing crew:", e);
            }
        }

        // --- Admin Action: Clear All ---

        clearAllBtn.addEventListener('click', () => {
            showModal("Are you sure you want to check out all rowers? This action cannot be undone.", async () => {
                const onWaterColRef = collection(db, 'artifacts', appId, 'public', 'data', 'on_water_log');
                const onWaterSnap = await getDocs(onWaterColRef);
                const batch = writeBatch(db);
                
                onWaterSnap.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
            });
        });

        // --- Admin Action: Add Member ---
        addMemberBtn.addEventListener('click', async () => {
            const name = addMemberNameInput.value.trim();
            if (!name) {
                setStatusMessage("Name cannot be empty.");
                return;
            }

            const membersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            const memberId = name.replace(/\s/g, '').toLowerCase();

            try {
                await setDoc(doc(membersColRef, memberId), { name: name });
                addMemberNameInput.value = '';
                setStatusMessage('Member added successfully!', 'success');
            } catch (e) {
                setStatusMessage(`Error adding member: ${e.message}`);
            }
        });

        // --- Search functionality ---
        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase().trim();
            if (searchTerm === '') {
                renderMembersList();
            } else {
                const filteredMembers = memberList.filter(member => 
                    member.name.toLowerCase().includes(searchTerm)
                );
                renderMembersList(filteredMembers);
            }
        });
        
        crewSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase().trim();
            if (searchTerm === '') {
                renderCrewMembersList();
            } else {
                const filteredMembers = memberList.filter(member => 
                    member.name.toLowerCase().includes(searchTerm)
                );
                renderCrewMembersList(filteredMembers);
            }
        });
        
        boatSearchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase().trim();
            if (searchTerm === '') {
                renderBoatsList();
            } else {
                const filteredBoats = boats.filter(boat => 
                    boat.name.toLowerCase().includes(searchTerm)
                );
                renderBoatsList(filteredBoats);
            }
        });
    </script>
</body>
</html>
